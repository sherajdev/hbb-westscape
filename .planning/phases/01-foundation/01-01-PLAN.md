---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - app/layout.tsx
  - app/page.tsx
  - app/ConvexClientProvider.tsx
  - convex/schema.ts
  - convex/auth.config.ts
  - middleware.ts
  - .env.local
autonomous: true
user_setup:
  - service: clerk
    why: "Authentication provider"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys"
      - name: CLERK_JWT_ISSUER_DOMAIN
        source: "Clerk Dashboard -> JWT Templates -> Create 'convex' template -> Issuer"
    dashboard_config:
      - task: "Create Clerk application for HBB@WestScape"
        location: "Clerk Dashboard -> Applications -> Create Application"
      - task: "Create JWT template named exactly 'convex'"
        location: "Clerk Dashboard -> JWT Templates -> New Template -> Convex"
  - service: convex
    why: "Backend database and serverless functions"
    env_vars:
      - name: NEXT_PUBLIC_CONVEX_URL
        source: "Auto-configured by npx convex dev"
      - name: CONVEX_DEPLOYMENT
        source: "Auto-configured by npx convex dev"

must_haves:
  truths:
    - "Next.js app runs locally on port 3000"
    - "Convex dashboard shows connected deployment"
    - "User can see Clerk sign-in UI on the page"
    - "Authenticated user identity is accessible in Convex functions"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "convex"
    - path: "app/layout.tsx"
      provides: "Root layout with ClerkProvider wrapping ConvexClientProvider"
      min_lines: 15
    - path: "app/ConvexClientProvider.tsx"
      provides: "Convex client with Clerk auth integration"
      exports: ["ConvexClientProvider"]
    - path: "convex/schema.ts"
      provides: "Database schema placeholder"
      contains: "defineSchema"
    - path: "convex/auth.config.ts"
      provides: "Clerk JWT configuration for Convex"
      contains: "CLERK_JWT_ISSUER_DOMAIN"
    - path: "middleware.ts"
      provides: "Clerk middleware for route protection"
      contains: "clerkMiddleware"
  key_links:
    - from: "app/layout.tsx"
      to: "app/ConvexClientProvider.tsx"
      via: "import and wrap children"
      pattern: "ConvexClientProvider"
    - from: "app/ConvexClientProvider.tsx"
      to: "convex/auth.config.ts"
      via: "JWT validation"
      pattern: "ConvexProviderWithClerk"
---

<objective>
Scaffold the HBB@WestScape project using the official Convex + Next.js + Clerk template and configure authentication.

Purpose: Establish the foundation that all other phases build upon - a working Next.js app with Convex backend and Clerk authentication properly integrated.

Output: A running local development environment where users can sign up/in via Clerk and their identity is available in Convex backend functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

Key patterns from research:
- Use `npm create convex@latest -- -t nextjs-clerk` for proper template setup
- ClerkProvider must wrap ConvexProviderWithClerk (outer to inner)
- JWT template in Clerk must be named exactly "convex"
- Add "use client" directive for components using hooks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold project with Convex + Clerk template</name>
  <files>
    package.json
    next.config.ts
    app/layout.tsx
    app/page.tsx
    app/ConvexClientProvider.tsx
    convex/schema.ts
    convex/auth.config.ts
    middleware.ts
    tsconfig.json
    tailwind.config.ts
  </files>
  <action>
    Run the official Convex template scaffolding command:
    ```bash
    npm create convex@latest -- -t nextjs-clerk
    ```

    When prompted:
    - Project name: use current directory (.) or "hbb-westscape"
    - Accept defaults for other options

    This creates the proper folder structure with:
    - Next.js 15 App Router setup
    - Convex configuration
    - Clerk provider integration
    - Middleware for auth

    After scaffolding, verify the key files exist:
    - app/layout.tsx (with ClerkProvider)
    - app/ConvexClientProvider.tsx (or similar provider file)
    - convex/schema.ts
    - convex/auth.config.ts
    - middleware.ts
  </action>
  <verify>
    - `ls -la app/` shows layout.tsx and page.tsx
    - `ls -la convex/` shows schema.ts and auth.config.ts
    - `cat package.json | grep convex` shows convex dependency
    - `cat package.json | grep clerk` shows @clerk/nextjs dependency
  </verify>
  <done>Project scaffolded with all required template files in place</done>
</task>

<task type="auto">
  <name>Task 2: Configure environment variables and verify auth flow</name>
  <files>
    .env.local
    convex/auth.config.ts
  </files>
  <action>
    1. Create .env.local with placeholder structure (user will fill in actual values):
    ```
    # Clerk - get from https://dashboard.clerk.com
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxx
    CLERK_SECRET_KEY=sk_test_xxx

    # Clerk JWT Issuer - MUST create JWT template named "convex" in Clerk Dashboard
    CLERK_JWT_ISSUER_DOMAIN=https://xxx.clerk.accounts.dev

    # Convex - auto-configured by npx convex dev
    NEXT_PUBLIC_CONVEX_URL=
    CONVEX_DEPLOYMENT=
    ```

    2. Update convex/auth.config.ts to use the environment variable:
    ```typescript
    export default {
      providers: [
        {
          domain: process.env.CLERK_JWT_ISSUER_DOMAIN!,
          applicationID: "convex",
        },
      ],
    };
    ```

    3. Ensure .gitignore includes .env.local (should be there from template)

    4. Run `npm install` to install dependencies

    5. Run `npx convex dev` to:
       - Create Convex deployment
       - Auto-configure NEXT_PUBLIC_CONVEX_URL
       - Push initial schema

    6. In a separate terminal, run `npm run dev` to start Next.js

    7. Visit http://localhost:3000 to verify:
       - Page loads without errors
       - Clerk sign-in UI is visible
  </action>
  <verify>
    - `cat .env.local` shows all required env vars
    - `npm run dev` starts without errors
    - Browser at localhost:3000 shows the app
    - Convex dashboard (dashboard.convex.dev) shows the deployment
  </verify>
  <done>Environment configured, both Convex and Next.js dev servers running, Clerk auth UI visible</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end auth integration</name>
  <files>
    convex/users.ts
    app/page.tsx
  </files>
  <action>
    1. Create a simple test query in convex/users.ts to verify auth works:
    ```typescript
    import { query } from "./_generated/server";

    export const getAuthStatus = query({
      args: {},
      handler: async (ctx) => {
        const identity = await ctx.auth.getUserIdentity();
        if (!identity) {
          return { authenticated: false, user: null };
        }
        return {
          authenticated: true,
          user: {
            clerkId: identity.subject,
            email: identity.email,
            name: identity.name,
          },
        };
      },
    });
    ```

    2. Update app/page.tsx to display auth status (ensure "use client" directive):
    ```typescript
    "use client";
    import { useQuery } from "convex/react";
    import { useConvexAuth } from "convex/react";
    import { api } from "@/convex/_generated/api";
    import { SignInButton, SignOutButton, useUser } from "@clerk/nextjs";

    export default function Home() {
      const { isLoading, isAuthenticated } = useConvexAuth();
      const authStatus = useQuery(
        api.users.getAuthStatus,
        isAuthenticated ? {} : "skip"
      );
      const { user } = useUser();

      if (isLoading) {
        return <div className="p-8">Loading...</div>;
      }

      return (
        <main className="p-8">
          <h1 className="text-2xl font-bold mb-4">HBB@WestScape</h1>

          {!isAuthenticated ? (
            <div>
              <p className="mb-4">Please sign in to continue</p>
              <SignInButton mode="modal">
                <button className="bg-blue-500 text-white px-4 py-2 rounded">
                  Sign In
                </button>
              </SignInButton>
            </div>
          ) : (
            <div>
              <p className="mb-2">Welcome, {user?.firstName || authStatus?.user?.name}!</p>
              <p className="text-sm text-gray-600 mb-4">
                Auth status from Convex: {authStatus?.authenticated ? "Authenticated" : "Loading..."}
              </p>
              <SignOutButton>
                <button className="bg-gray-500 text-white px-4 py-2 rounded">
                  Sign Out
                </button>
              </SignOutButton>
            </div>
          )}
        </main>
      );
    }
    ```

    3. Test the full flow:
       - Visit localhost:3000
       - Click Sign In
       - Create account or sign in with test credentials
       - Verify "Auth status from Convex: Authenticated" appears
       - Verify user name displays
       - Sign out and verify UI returns to sign-in state
  </action>
  <verify>
    - `npx convex dev` shows no errors and functions deploy
    - Sign in flow completes without errors
    - After sign in, page shows "Authenticated" from Convex query
    - Sign out returns to sign-in state
    - Browser console has no auth-related errors
  </verify>
  <done>User can sign up, sign in, and their identity is correctly passed to Convex backend functions</done>
</task>

</tasks>

<verification>
Phase 1 Plan 01 is complete when:
1. `npm run dev` starts Next.js on localhost:3000 without errors
2. `npx convex dev` connects to Convex deployment without errors
3. User can sign up via Clerk modal
4. User can sign in via Clerk modal
5. After sign-in, Convex query returns `authenticated: true` with user data
6. Sign out works and returns user to unauthenticated state
</verification>

<success_criteria>
- Next.js app runs locally with Convex backend connected
- User can sign up and log in via Clerk
- Authenticated user identity accessible in Convex functions
- All template files in place for Plan 02 to build upon
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md` documenting:
- Files created by template
- Environment variables configured
- Verification results
- Any deviations from plan
</output>
