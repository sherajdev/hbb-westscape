---
phase: 02-public-directory
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/businesses.ts
  - next.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Public query returns only approved businesses"
    - "Business query includes image and video URLs"
    - "Category filtering works at query level"
    - "Next.js can render Convex storage images"
  artifacts:
    - path: "convex/businesses.ts"
      provides: "listApprovedBusinesses, getBusinessWithImages queries"
      exports: ["listApprovedBusinesses", "getBusinessWithImages"]
    - path: "next.config.ts"
      provides: "Convex cloud image domain configuration"
      contains: "convex.cloud"
  key_links:
    - from: "convex/businesses.ts"
      to: "convex/schema.ts"
      via: "by_status index query"
      pattern: "withIndex.*by_status"
    - from: "convex/businesses.ts"
      to: "ctx.storage"
      via: "getUrl for images/video"
      pattern: "storage\\.getUrl"
---

<objective>
Add public Convex queries for the directory and configure Next.js for Convex images.

Purpose: Enable frontend to fetch approved businesses with images without authentication.
Output: Public API queries ready for directory and profile pages, Next.js Image component works with Convex URLs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-public-directory/02-RESEARCH.md

# Schema reference
@convex/schema.ts
@convex/businesses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add public queries to convex/businesses.ts</name>
  <files>convex/businesses.ts</files>
  <action>
Add two public queries to the existing convex/businesses.ts file:

1. `listApprovedBusinesses` query:
   - Args: optional `category` (Food | Beauty | Fusion | Services)
   - No auth required (public query)
   - Use `.withIndex("by_status", q => q.eq("status", "approved"))` to filter
   - If category provided, filter results in code (cannot composite index easily)
   - Return array of businesses

2. `getBusinessWithImages` query:
   - Args: `businessId: v.id("businesses")`
   - No auth required (public query)
   - Fetch business by ID
   - Return null if not found OR if status !== "approved"
   - Generate image URLs using `ctx.storage.getUrl(id)` for each imageStorageId
   - Generate video URL using `ctx.storage.getUrl()` if videoStorageId exists
   - Return business object spread with `imageUrls: string[]` and `videoUrl: string | null`

Keep all existing queries (createBusiness, getMyBusiness, canCreateBusiness) unchanged.
  </action>
  <verify>
Run `npx convex dev` (if not running) to push functions.
Check Convex dashboard shows new queries.
  </verify>
  <done>
listApprovedBusinesses and getBusinessWithImages queries exist and are public (no auth check).
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Next.js for Convex storage images</name>
  <files>next.config.ts</files>
  <action>
Update next.config.ts to allow Next.js Image component to load images from Convex storage.

Add remotePatterns configuration:
```typescript
const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.convex.cloud',
        pathname: '/**',
      },
    ],
  },
};
```

This allows Next.js Image to optimize images from any Convex storage URL.
  </action>
  <verify>
Verify file syntax: `npx tsc --noEmit` should pass.
  </verify>
  <done>
next.config.ts has images.remotePatterns with Convex cloud pattern.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install lucide-react icons</name>
  <files>package.json</files>
  <action>
Install lucide-react for contact modal icons and UI accents:

```bash
npm install lucide-react
```

This icon library provides Phone, MessageCircle (WhatsApp), Instagram, Music (TikTok), Facebook, ShoppingBag (Carousell), Globe (Website), and other UI icons needed for the contact modal and business cards.
  </action>
  <verify>
Run `npm ls lucide-react` to confirm installation.
  </verify>
  <done>
lucide-react is installed and available for import.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx convex dev` runs without errors
2. Convex dashboard shows listApprovedBusinesses and getBusinessWithImages in functions list
3. `npm ls lucide-react` shows the package
4. `npx tsc --noEmit` passes (no TypeScript errors)
</verification>

<success_criteria>
- Public queries added to convex/businesses.ts
- Queries filter for approved status and resolve storage URLs
- Next.js configured to accept Convex image URLs
- lucide-react installed for icons
</success_criteria>

<output>
After completion, create `.planning/phases/02-public-directory/02-01-SUMMARY.md`
</output>
